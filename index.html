<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inserimento Tempi Lavorazione</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;
            --md-sys-color-secondary: #625B71;
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #E8DEF8;
            --md-sys-color-on-secondary-container: #1D192B;
            --md-sys-color-surface: #FFFBFE;
            --md-sys-color-on-surface: #1C1B1F;
            --md-sys-color-surface-variant: #E7E0EC;
            --md-sys-color-on-surface-variant: #49454F;
            --md-sys-color-outline: #79747E;
            --md-sys-color-error: #B3261E;
            --md-sys-color-success: #28a745;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface);
        }

        .card {
            @apply bg-white rounded-2xl p-6 shadow-lg transition-all duration-300;
        }

        .btn {
            @apply px-6 py-3 rounded-full font-semibold text-sm tracking-wide transition-all duration-300 flex items-center justify-center gap-2;
        }

        .btn-primary {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }
        .btn-primary:hover:not(:disabled) {
            @apply shadow-md;
        }
        .btn:disabled {
            @apply bg-gray-300 cursor-not-allowed;
        }

        .btn-secondary {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }

        .select-input {
            @apply w-full p-4 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200;
        }

        .chip-container {
            @apply flex flex-wrap gap-3;
        }

        .chip {
            @apply px-4 py-2 rounded-lg cursor-pointer transition-colors duration-200 border-2;
            background-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface-variant);
            border-color: var(--md-sys-color-outline);
        }

        .chip.selected {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            border-color: var(--md-sys-color-primary);
        }

        .loader {
            @apply border-4 border-gray-200 border-t-blue-500 rounded-full w-12 h-12 animate-spin;
        }
        
        .status-card {
            @apply p-4 rounded-lg text-center font-medium;
        }
        .status-working {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }
        .status-success {
            background-color: var(--md-sys-color-success);
            color: white;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-md mx-auto p-4">
        
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Inserimento Tempi</h1>
            <p id="welcome-message" class="text-gray-600 mt-1"></p>
        </header>

        <!-- Login View -->
        <div id="login-view" class="card text-center">
             <h2 class="text-xl font-medium mb-4">Accedi per iniziare</h2>
             <button id="login-btn" class="btn btn-primary mx-auto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M21.35 11.1H12.18V13.83H18.69C18.36 17.64 15.19 19.27 12.19 19.27C8.36 19.27 5.03 16.25 5.03 12.5C5.03 8.75 8.36 5.73 12.19 5.73C14.03 5.73 15.6 6.36 16.84 7.48L19.09 5.23C17.21 3.42 14.84 2.5 12.19 2.5C6.92 2.5 2.73 6.73 2.73 12.5C2.73 18.27 6.92 22.5 12.19 22.5C17.6 22.5 21.54 18.53 21.54 12.81C21.54 12.09 21.47 11.6 21.35 11.1Z"/></svg>
                 <span>Accedi con Google</span>
            </button>
        </div>

        <!-- App Loader -->
        <div id="app-loader" class="hidden text-center card">
            <div class="loader mx-auto"></div>
            <p class="mt-4">Caricamento dati...</p>
        </div>
        
        <!-- Main App View -->
        <main id="app-view" class="hidden space-y-6">
            <div class="card">
                 <div id="status-container" class="mb-4"></div>
                 
                 <div id="selection-form" class="space-y-4">
                    <div>
                        <label for="commesse-select" class="block mb-2 text-sm font-medium text-gray-700">1. Seleziona Commessa</label>
                        <select id="commesse-select" class="select-input">
                            <option value="">Scegli una commessa...</option>
                        </select>
                    </div>

                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-700">2. Seleziona Fase</label>
                        <div id="fasi-container" class="chip-container">
                            <!-- Chips will be inserted here by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="flex gap-4">
                    <button id="start-btn" class="btn btn-primary w-full">INIZIO</button>
                    <button id="stop-btn" class="btn btn-secondary w-full" disabled>FINE</button>
                </div>
            </div>

            <div class="text-center">
                 <button id="logout-btn" class="text-sm text-gray-500 hover:underline">Disconnetti</button>
            </div>
        </main>
    </div>

    <script type="module">
        // Importa le funzioni di Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut, 
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            query, 
            where, 
            doc, 
            setDoc,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAZIONE FIREBASE (Con le tue credenziali) ---
        const firebaseConfig = {
            apiKey: "AIzaSyA-mCmPa__kbznioZHtIvG61k8GSgvenyQ",
            authDomain: "ii-gestione-tempi-lavorazione.firebaseapp.com",
            projectId: "ii-gestione-tempi-lavorazione",
            storageBucket: "ii-gestione-tempi-lavorazione.appspot.com", // Corretto per coerenza, ma non usato in questa app.
            messagingSenderId: "304793513353",
            appId: "1:304793513353:web:df9355f8e0620f67c5c558",
            measurementId: "G-FBB0RNPWZZ"
        };

        // --- INIZIALIZZAZIONE FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- RIFERIMENTI DOM ---
        const loginView = document.getElementById('login-view');
        const appLoader = document.getElementById('app-loader');
        const appView = document.getElementById('app-view');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const welcomeMessage = document.getElementById('welcome-message');
        const commesseSelect = document.getElementById('commesse-select');
        const fasiContainer = document.getElementById('fasi-container');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const statusContainer = document.getElementById('status-container');
        const selectionForm = document.getElementById('selection-form');

        // --- STATO APPLICAZIONE ---
        let currentUser = null;
        let currentOperator = null;
        let selectedCommessa = null;
        let selectedFase = null;
        let activeWorkSessionId = null;

        // --- LOGICA DI AUTENTICAZIONE ---
        loginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Errore durante il login con Google:", error);
                statusContainer.innerHTML = `<div class="status-card" style="background-color: var(--md-sys-color-error); color: white;">Login fallito. Riprova.</div>`;
            }
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                loginView.classList.add('hidden');
                appView.classList.add('hidden');
                appLoader.classList.remove('hidden');

                await initializeAppForUser(user);

                appLoader.classList.add('hidden');
                appView.classList.remove('hidden');
            } else {
                currentUser = null;
                currentOperator = null;
                resetUI();
                loginView.classList.remove('hidden');
                appLoader.classList.add('hidden');
                appView.classList.add('hidden');
                welcomeMessage.textContent = '';
            }
        });

        // --- FUNZIONI PRINCIPALI ---
        async function initializeAppForUser(user) {
            try {
                const operatoriRef = collection(db, "operatori");
                const q = query(operatoriRef, where("MAIL", "==", user.email));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    throw new Error("Operatore non trovato per l'email: " + user.email);
                }
                
                const operatorDoc = querySnapshot.docs[0];
                currentOperator = operatorDoc.data().OPERATORE;
                welcomeMessage.textContent = `Benvenuto, ${currentOperator}!`;
                
                await Promise.all([
                    loadCommesse(),
                    loadFasi(),
                    checkForActiveSession()
                ]);

            } catch (error) {
                console.error("Errore di inizializzazione:", error);
                appView.innerHTML = `<div class="card text-center text-red-600">${error.message}</div>`;
            }
        }

        async function loadCommesse() {
            const commesseRef = collection(db, "commesseAPERTE");
            const snapshot = await getDocs(commesseRef);
            commesseSelect.innerHTML = '<option value="">Scegli una commessa...</option>';
            snapshot.forEach(doc => {
                const commessa = doc.data();
                const option = document.createElement('option');
                option.value = commessa.COMMESSA;
                option.textContent = `${commessa.CLIENTE} - ${commessa.PRODOTTO} (${commessa.COMMESSA})`;
                commesseSelect.appendChild(option);
            });
        }

        async function loadFasi() {
            const fasiRef = collection(db, "fasi");
            const snapshot = await getDocs(fasiRef);
            fasiContainer.innerHTML = '';
            snapshot.forEach(doc => {
                const fase = doc.data();
                const chip = document.createElement('button');
                chip.classList.add('chip');
                chip.textContent = fase.FASI;
                chip.dataset.fase = fase.FASI;
                fasiContainer.appendChild(chip);
            });
        }
        
        async function checkForActiveSession() {
            if (!currentOperator) return;
            const registroRef = collection(db, "registroLAVORAZIONI");
            const q = query(registroRef, 
                where("Operatore", "==", currentOperator),
                where("DataOra_Fine", "==", null)
            );
            const snapshot = await getDocs(q);
            if (!snapshot.empty) {
                const activeSession = snapshot.docs[0];
                activeWorkSessionId = activeSession.id;
                const data = activeSession.data();
                updateUIForActiveSession(data.CodiceCommessa, data.Fase);
            } else {
                resetUI();
            }
        }


        // --- GESTIONE EVENTI UI ---
        commesseSelect.addEventListener('change', (e) => {
            selectedCommessa = e.target.value;
        });

        fasiContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('chip')) {
                document.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
                e.target.classList.add('selected');
                selectedFase = e.target.dataset.fase;
            }
        });

        startBtn.addEventListener('click', async () => {
            if (!selectedCommessa || !selectedFase) {
                showStatusMessage("Seleziona una commessa e una fase prima di iniziare.", "error");
                return;
            }

            activeWorkSessionId = crypto.randomUUID();
            const workData = {
                CodiceCommessa: selectedCommessa,
                Fase: selectedFase,
                Operatore: currentOperator,
                DataOra_Inizio: new Date(),
                DataOra_Fine: null
            };

            try {
                const docRef = doc(db, "registroLAVORAZIONI", activeWorkSessionId);
                await setDoc(docRef, workData);
                updateUIForActiveSession(selectedCommessa, selectedFase);
            } catch (error) {
                console.error("Errore nell'avvio della lavorazione:", error);
                showStatusMessage("Errore di connessione. Impossibile avviare.", "error");
                activeWorkSessionId = null;
            }
        });

        stopBtn.addEventListener('click', async () => {
            if (!activeWorkSessionId) return;

            try {
                const docRef = doc(db, "registroLAVORAZIONI", activeWorkSessionId);
                await updateDoc(docRef, {
                    DataOra_Fine: new Date()
                });
                showStatusMessage("Lavorazione terminata con successo!", "success");
                activeWorkSessionId = null;
                resetUI();
            } catch (error) {
                console.error("Errore nel terminare la lavorazione:", error);
                showStatusMessage("Errore di connessione. Impossibile terminare.", "error");
            }
        });

        // --- FUNZIONI DI UTILITÀ ---
        function updateUIForActiveSession(commessa, fase) {
            selectionForm.classList.add('opacity-50', 'pointer-events-none');
            startBtn.disabled = true;
            stopBtn.disabled = false;
            showStatusMessage(`Lavoro in corso: <strong>${fase}</strong> per <strong>${commessa}</strong>`, "working");
        }

        function resetUI() {
            selectionForm.classList.remove('opacity-50', 'pointer-events-none');
            startBtn.disabled = false;
            stopBtn.disabled = true;
            commesseSelect.value = '';
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
            selectedCommessa = null;
            selectedFase = null;
            setTimeout(() => {
                if (!activeWorkSessionId) statusContainer.innerHTML = '';
            }, 3000); // Rimuove il messaggio di successo dopo 3 secondi
        }
        
        function showStatusMessage(message, type = "working") {
             let statusClass = 'status-working';
             if (type === 'error') statusClass = 'status-card" style="background-color: var(--md-sys-color-error); color: white;';
             if (type === 'success') statusClass = 'status-success';

             statusContainer.innerHTML = `<div class="status-card ${statusClass}">${message}</div>`;
        }

    </script>
</body>
</html>

